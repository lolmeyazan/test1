// ===================================
//              server.js
// ===================================
// ููู ุงูุฎุงุฏู ุงูุฎููู (Backend) ูุฅุฏุงุฑุฉ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู Node.js ู MongoDB.
// ูุฐุง ุงูููู ุณูุชู ูุดุฑู ุนูู Render ููุญุตูู ุนูู ุฑุงุจุท ุนุงู.
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');

const app = express();
// ุงุณุชุฎุฏุงู ุงููููุฐ ุงูุฐู ูููุฑู Render (process.env.PORT) ุฃู ุงููููุฐ 3000 ููุชุทููุฑ ุงููุญูู.
const PORT = process.env.PORT || 3000; 

// ๐จ ุณุญุจ ูููุฉ ุงููุฑูุฑ ูู ูุชุบูุฑ ุงูุจูุฆุฉ MONGO_PASSWORD ุงูุฐู ุชู ุชุนูููู ูู ุฅุนุฏุงุฏุงุช Render.
const MONGO_PASSWORD = process.env.MONGO_PASSWORD; 

// ุงุณุชุฎุฏุงู ุงุณู ุงููุณุชุฎุฏู lolmeyazan ู ุฑุงุจุท Cluster01.xrgbepqุ ูุน ุฅุถุงูุฉ ุงุณู ูุงุนุฏุฉ ุงูุจูุงูุงุช siteDB.
const MONGO_URI = `mongodb+srv://lolmeyazan:Cluster0@cluster0.v4wwyi5.mongodb.net/`;

// ----------------------------------------------------
// ุฅุนุฏุงุฏุงุช Middleware
// ----------------------------------------------------
// ุชูุนูู CORS ููุณูุงุญ ููุตูุญุฉ ุงูุฃูุงููุฉ (ProFreeHost) ุจุงูุงุชุตุงู ุจุงูุฎุงุฏู (Render)
app.use(cors()); 
app.use(express.json()); // ูุชุญููู ุงูุจูุงูุงุช ุงููุฑุณูุฉ ุจุตูุบุฉ JSON

// ----------------------------------------------------
// ุชุนุฑูู ูููุฐุฌ ุงูุจูุงูุงุช (Mongoose Schema)
// ----------------------------------------------------
// ูููุฐุฌ ูุญูุธ ูุญุชูู ุงููููุน ูู ูุงุฆู ูุงุญุฏ (ูุชุจุณูุท ุนูููุฉ ุงูุชุนุฏูู ูุงูุฅุฏุงุฑุฉ).
const DataSchema = new mongoose.Schema({
    data: Object, // ุงููุงุฆู ุงูุฐู ุณูุญูู ุฌููุน ุจูุงูุงุช ุงููููุน (ุงูุณูุงุฑุงุชุ ุงูุนุฑูุถุ ุฅูุฎ)
    lastUpdated: { type: Date, default: Date.now }
});
const DataModel = mongoose.model('SiteData', DataSchema);

// ----------------------------------------------------
// ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
// ----------------------------------------------------
if (MONGO_PASSWORD) {
    mongoose.connect(MONGO_URI)
        .then(() => console.log('โ ุชู ุงูุงุชุตุงู ุจูุฌุงุญ ุจู MongoDB Atlas'))
        .catch(err => {
            console.error('โ ูุดู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช. (ุฑุงุฌุน ูุชุบูุฑุงุช ุงูุจูุฆุฉ ู IP Access List):', err.message);
        });
} else {
    console.error('โ ูุดู ุจุฏุก ุงูุฎุงุฏู: ูู ูุชู ุงูุนุซูุฑ ุนูู ูุชุบูุฑ ุงูุจูุฆุฉ MONGO_PASSWORD.');
}

// ----------------------------------------------------
// 1. ูุณุงุฑ ุชุญููู ุงูุจูุงูุงุช (GET /api/data/load)
// ----------------------------------------------------
app.get('/api/data/load', async (req, res) => {
    try {
        // ุงูุจุญุซ ุนู ุขุฎุฑ ูุณุชูุฏ ูุงุญุฏ ุชู ุญูุธู
        const latestData = await DataModel.findOne().sort({ lastUpdated: -1 });
        // ุฅุฑุฌุงุน ูุงุฆู ุงูุจูุงูุงุช ุงููุญููุธุฉ
        return res.json(latestData ? latestData.data : {}); 
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
        res.status(500).json({ message: 'ูุดู ุงูุฎุงุฏู ูู ุชุญููู ุงูุจูุงูุงุช' });
    }
});

// ----------------------------------------------------
// 2. ูุณุงุฑ ุญูุธ ุงูุจูุงูุงุช (POST /api/data/save)
// ----------------------------------------------------
app.post('/api/data/save', async (req, res) => {
    try {
        const incomingData = req.body;
        
        // ุชุญุฏูุซ ุงูุณุฌู ุงููุญูุฏ ุงูููุฌูุฏุ ุฃู ุฅูุดุงุคู ุฅุฐุง ูู ููู ููุฌูุฏุงู (upsert: true)
        await DataModel.findOneAndUpdate(
            {}, 
            { data: incomingData, lastUpdated: new Date() },
            { new: true, upsert: true }
        );

        res.status(200).json({ message: 'ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ ูู MongoDB' });
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:', error);
        res.status(500).json({ message: 'ูุดู ุงูุฎุงุฏู ูู ุญูุธ ุงูุจูุงูุงุช' });
    }
});


// ุชุดุบูู ุงูุฎุงุฏู
app.listen(PORT, () => {
    console.log(`๐ ุงูุฎุงุฏู ูุนูู ุงูุขู ุนูู ูููุฐ: ${PORT}`); 
    console.log(`(ูุฐุง ูู ุงูุฑุงุจุท ุงูุฐู ูุฌุจ ุงูุงุชุตุงู ุจู ูู ุงููุชุตูุญ: http://localhost:${PORT})`);
});
